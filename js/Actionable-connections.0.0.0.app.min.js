/**
 ******* Actionable-connections *******
 * 
 * @version v0.0.0 - 2015-01-30
 * @link 
 * @author Almog Baku
 * @license MIT
 */
"use strict";function linkedin_load(){getApp("$rootScope").$broadcast("linkedIn.load",window.IN)}function getApp(a){return angular.element(document).injector().get(a)}try{angular.module("app.templates")}catch(e){angular.module("app.templates",[])}angular.module("app",["ui.router","app.auth","cfp.hotkeys","angulartics","angulartics.google.analytics"]).config(["$stateProvider","$urlRouterProvider",function(a,b){a.state("home",{url:"/",templateUrl:"src/app/views/home.html"}).state("report",{authenticated:!0,url:"/report",controller:"reportCtrl",templateUrl:"src/app/views/report.html"}).state("addContact",{authenticated:!0,url:"/addContact",controller:"addContactCtrl",templateUrl:"src/app/views/addContact.html"}).state("start",{authenticated:!0,url:"/start",controller:"startCtrl",templateUrl:"src/app/views/start.html"}).state("connection",{authenticated:!0,url:"/connection/:idx",controller:"connectionCtrl",templateUrl:"src/app/views/connection.html"}).state("login",{anonymous:!0,url:"/login",controller:"loginCtrl",templateUrl:"src/app/views/login.html"}),b.otherwise("/")}]),angular.module("app").controller("addContactCtrl",["$scope","$linkedin","$state","hotkeys","$timeout",function(a,b,c,d,e){a.error=!1,a.success=!1,a.add=function(){b.addConnectionByUrl(a.connUrl).then(function(){a.success=!0,a.error=!1,e(function(){c.go("report")},1500)})["catch"](function(b){a.error=b.message})};var f=b.getFirstNotFlagged();f!==!1&&d.bindTo(a).add({combo:"j",description:"Jump back to the first skipped connection",callback:function(){c.go("connection",{idx:f.idx})}}).add({combo:"r",description:"Go back to the results report",callback:function(){c.go("report")}})}]),angular.module("app").controller("connectionCtrl",["$scope","$linkedin","$state","$stateParams","hotkeys","$analytics",function(a,b,c,d,e,f){function g(b,c){var d=c.combo[0];a.connection.flag(d),f.eventTrack("flag",{flag:d}),h()}function h(){a.connection.idx===a.last?c.go("finish"):c.go("connection",{idx:a.connection.idx+1})}f.pageTrack("/connection"),a.connection=b.getConnectionByIdx(d.idx),a.last=b.getLastConnectionIdx(),e.bindTo(a).add({combo:["n","3"],description:"Need intro",callback:g}).add({combo:["0","x"],description:"Not relevant",callback:g}).add({combo:"1",description:"Will help",callback:g}).add({combo:"2",description:"Will help a lot! (good-friend)",callback:g}).add({combo:"right",description:"Next (skip)",callback:h}).add({combo:"j",description:"Jump back to the first skipped connection",callback:function(){var a=b.getFirstNotFlagged();a===!1?c.go("finish"):c.go("connection",{idx:a.idx})}}).add({combo:"r",description:"Skip to the results report",callback:function(){c.go("report")}}),a.connection.idx>0&&e.bindTo(a).add({combo:"left",description:"back",callback:function(){a.connection.idx>0&&c.go("connection",{idx:a.connection.idx-1})}})}]),angular.module("app").controller("loginCtrl",["$scope","Auth",function(a,b){a.login=b.login}]),angular.module("app").controller("reportCtrl",["$scope","$linkedin","$state","hotkeys","exportCSV","$analytics",function(a,b,c,d,e,f){a.loadReport=function(){b.getGroupedConnections().then(function(b){a.connections=b})},a.loadReport(),a.flagChanged=function(){a.loadReport()},a.exportCSV=function(){f.eventTrack("export"),b.toObject().then(function(a){e(a,"connections",!0)})};var g=b.getFirstNotFlagged();g!==!1&&d.bindTo(a).add({combo:"j",description:"Jump back to the first skipped connection",callback:function(){c.go("connection",{idx:g.idx})}}).add({combo:"a",description:"Add contact that not on your LinkedIn connections",callback:function(){c.go("addContact")}}).add({combo:"r",description:"Reload report",callback:a.loadReport}).add({combo:"e",description:"Export",callback:a.exportCSV})}]),angular.module("app").controller("startCtrl",["$scope","$linkedin","$state","hotkeys",function(a,b,c,d){b.getMe().then(function(b){a.user=b}),a.ready=!1,b.getConnections().then(function(){a.ready=!0})["catch"](function(){a.error=!0}),d.bindTo(a).add({combo:["s","right"],description:"start",callback:function(){a.ready&&c.go("connection",{idx:0})}})}]),angular.module("app.auth",["ngAuthBase"]).factory("Auth",["$linkedin","AuthBaseUI","$rootScope",function(a,b,c){var d=angular.extend(b,{});return d.setSecuredPath("start"),d.setIsLoggedIn(function(){return a.getStatus()}),d.login=a.login,d.logout=a.logout,c.$on("linkedIn.status",function(){d.statusChanged(a.getStatus())}),d}]).run(["Auth",function(){}]),angular.module("app").service("exportCSV",["$rootScope",function(){return function(a,b,c){var d,e="object"!=typeof a?JSON.parse(a):a,f="";if(c){d="";for(var g in e[0])d+=g+",";d=d.slice(0,-1),f+=d+"\r\n"}for(var h=0;h<e.length;h++){var d="";for(var g in e[h])d+='"'+e[h][g]+'",';d.slice(0,d.length-1),f+=d+"\r\n"}if(""==f)throw Error("Invalid data");var i="Report_";i+=b.replace(/ /g,"_");var j="data:text/csv;charset=utf-8,"+escape(f),k=document.createElement("a");k.href=j,k.style="visibility:hidden",k.download=i+".csv",document.body.appendChild(k),k.click(),document.body.removeChild(k)}}]),angular.module("app").service("$linkedin",["$rootScope","$q",function(a,b){function c(){var a=b.defer(),c=this;return f.API.Raw("/people/"+c.id+"/relation-to-viewer/related-connections?count=99").result(function(b){c.mutual=[];var d=b.values;if(d)for(var e=0;e<d.length;e++)c.mutual.push(h[d[e].id]);a.resolve(c)}).error(function(b){a.reject(b)}),a.promise}function d(a){return a.idx=i.length,a.getMutualConnections=c,a.flag=function(a){return void 0===a?this._flag:(this._flag=a,void("n"===a&&this.getMutualConnections()))},void 0!==a.siteStandardProfileRequest&&(a.url=a.siteStandardProfileRequest.url),h[a.id]=a,i.push(h[a.id]),h[a.id]}function e(a){switch(a){case"0":return-1;case"n":return-2;case"1":return 1;case"2":return 2;default:return 0}}var f=null,g=["id","first-name","last-name","headline","industry","picture-url","site-standard-profile-request","email-address","positions"];a.$on("linkedIn.load",function(b,c){function d(){a.$broadcast("linkedIn.status",f.User.isAuthorized())}f=c,f.Event.on(f,"auth",d),f.Event.on(f,"logout",d),d()}),this.getSDK=function(){return f},this.getStatus=function(){return null===f?null:f.User.isAuthorized()},this.login=function(){return f.User.authorize()},this.logout=function(){return f.User.logout()},this.getMe=function(){var a=b.defer();return f.API.Profile("me").result(function(b){a.resolve(b.values[0])}).error(function(b){a.reject(b)}),a.promise};var h={},i=[];return this.getConnections=function(a){var c=b.defer();return i.length&&!a?c.resolve(h):f.API.Connections("me").fields(g).result(function(a){for(var b=a.values.filter(function(a){return"private"!==a.id}),e=0;e<b.length;e++)d(b[e]);c.resolve(h)}).error(function(a){c.reject(a)}),c.promise},this.getConnectionsArr=function(a){var c=b.defer();return i.length&&!a?c.resolve(i):this.getConnections(a).then(function(){c.resolve(i)}).error(function(a){c.reject(a)}),c.promise},this.getConnectionByID=function(a){return i.length<1&&this.getConnections(),h[a]},this.getConnectionByIdx=function(a){return i.length<1&&this.getConnectionsArr(),i[a]},this.getLastConnectionIdx=function(){return i.length-1},this.getFirstNotFlagged=function(){for(var a=0;a<i.length;a++)if(void 0===i[a].flag())return i[a];return!1},this.addConnectionByUrl=function(a,c){var e=b.defer();void 0===c&&(c="n");return f.API.Raw("/people/url="+encodeURIComponent(a)+":("+g.join(",")+")").result(function(a){var b=d(a);b.flag(c),e.resolve(b)}).error(function(a){e.reject(a)}),e.promise},this.getGroupedConnections=function(){var a=b.defer(),c={0:[],n:[],1:[],2:[],skipped:[]};return this.getConnectionsArr().then(function(b){for(var d,f=0;f<b.length;f++)switch(d=b[f],d.flag()){case"0":c[0].push(d);break;case"n":c.n.push(d);break;case"1":c[1].push(d);break;case"2":c[2].push(d);break;default:c.skipped.push(d)}for(f=0;f<c.n.length;f++)d=c.n[f],d.mutual&&(d.mutual=d.mutual.sort(function(a,b){return a=e(a.flag()),b=e(b.flag()),b-a}));a.resolve(c)}),a.promise},this.toObject=function(){var a=b.defer(),c=[];return this.getConnectionsArr().then(function(b){for(var d,e=0;e<b.length;e++)d=b[e],c.push({Flag:void 0===d.flag()?"":d.flag(),"First name":d.firstName,"Last name":d.lastName,Headline:d.headline,Industry:d.industry,Url:d.url,"Linkedin ID":d.id});a.resolve(c)}),a.promise},this}]).run(["$linkedin",function(){}]),angular.element(document).ready(function(){angular.bootstrap(document,["app"])});